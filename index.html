<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Gang</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0e0e12; --surface:#1a1a22; --s2:#242430;
    --accent:#e8c84a; --red2:#c44b2b; --text:#f0ede6;
    --muted:#666675; --green:#3db87a; --red:#e05050;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(232,200,74,.04),transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(196,75,43,.04),transparent 50%);pointer-events:none;z-index:0;}
  #app{position:relative;z-index:1;}

  .screen{display:none;min-height:100vh;}
  .screen.active{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;}

  .logo h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(56px,10vw,100px);letter-spacing:.08em;color:var(--accent);line-height:.9;text-shadow:4px 4px 0 rgba(196,75,43,.4);text-align:center;}
  .logo p{font-size:12px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-top:6px;text-align:center;}

  .box{background:var(--surface);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:28px;width:100%;max-width:420px;}
  .box h2{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:.12em;color:var(--muted);margin-bottom:16px;}

  input{background:var(--s2);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:12px 16px;color:var(--text);font-family:'Barlow',sans-serif;font-size:15px;outline:none;transition:border-color .15s;width:100%;}
  input:focus{border-color:var(--accent);}
  input::placeholder{color:var(--muted);}

  .btn{width:100%;padding:14px;border:none;border-radius:10px;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.1em;cursor:pointer;transition:all .15s;margin-top:10px;}
  .btn-gold{background:var(--accent);color:#0e0e12;}
  .btn-gold:hover{background:#f0d460;transform:translateY(-1px);}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.1);}
  .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
  .btn:disabled{background:var(--s2);color:var(--muted);cursor:not-allowed;transform:none;}

  .divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--muted);font-size:12px;letter-spacing:.1em;}
  .divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.08);}

  /* LOBBY */
  #lobby{gap:16px;}
  .code-box{background:var(--s2);border:1px solid rgba(232,200,74,.2);border-radius:12px;padding:20px;text-align:center;width:100%;max-width:420px;}
  .code-lbl{font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
  .code{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:.2em;color:var(--accent);cursor:pointer;}
  .code-hint{font-size:11px;color:var(--muted);margin-top:4px;}
  .lobby-player{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:15px;}
  .lobby-player:last-child{border-bottom:none;}
  .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .dot-on{background:var(--green);}
  .dot-off{background:var(--muted);}
  .badge{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);background:rgba(232,200,74,.1);border-radius:4px;padding:2px 6px;margin-left:4px;}

  /* GAME */
  #game{display:none;flex-direction:column;min-height:100vh;padding:16px;max-width:900px;margin:0 auto;width:100%;}
  #game.active{display:flex;}
  .game-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:16px;}
  .gtitle{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--accent);letter-spacing:.1em;}
  .phase-dots{display:flex;gap:6px;}
  .pdot{width:8px;height:8px;border-radius:50%;background:var(--s2);border:1px solid var(--muted);transition:all .3s;}
  .pdot.done{background:var(--green);border-color:var(--green);}
  .pdot.active{background:var(--accent);border-color:var(--accent);box-shadow:0 0 8px rgba(232,200,74,.5);}
  .my-badge{font-size:13px;color:var(--muted);background:var(--s2);border-radius:20px;padding:6px 14px;}
  .my-badge span{color:var(--accent);font-weight:600;}

  .comm-section{background:var(--surface);border-radius:14px;padding:20px;margin-bottom:12px;border:1px solid rgba(255,255,255,.05);}
  .slabel{font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
  .comm-cards{display:flex;gap:10px;flex-wrap:wrap;}

  .card{width:62px;height:88px;border-radius:8px;border:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:20px;position:relative;flex-shrink:0;}
  .card.up{background:#f5f0e8;color:#1a1a22;}
  .card.up.hearts,.card.up.diamonds{color:#c0272d;}
  .card.dn{background:linear-gradient(135deg,#1e1e2e,#2a2a3e);border:2px solid rgba(232,200,74,.2);}
  .card.dn::after{content:'üÇ†';font-size:36px;opacity:.3;}
  .cc{position:absolute;top:4px;left:6px;font-size:11px;line-height:1;display:flex;flex-direction:column;align-items:center;}
  .cc.br{top:auto;left:auto;bottom:4px;right:6px;transform:rotate(180deg);}
  .cs{font-size:28px;}
  .card.anim{animation:flip .4s ease-out both;}
  @keyframes flip{0%{transform:rotateY(90deg) scale(.8);opacity:0}100%{transform:rotateY(0) scale(1);opacity:1}}

  .instr{background:linear-gradient(135deg,rgba(232,200,74,.08),rgba(232,200,74,.03));border:1px solid rgba(232,200,74,.2);border-radius:12px;padding:14px 20px;margin-bottom:12px;font-size:14px;text-align:center;line-height:1.5;}
  .instr strong{color:var(--accent);font-weight:600;}

  .players{display:flex;flex-direction:column;gap:10px;flex:1;}
  .ppanel{background:var(--surface);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:10px;transition:border-color .2s;}
  .ppanel.me{border-color:rgba(232,200,74,.3);background:rgba(232,200,74,.03);}
  .ppanel.offline{opacity:.5;}
  .ptop{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  .pinfo{flex:1;min-width:0;}
  .pname{font-weight:600;font-size:15px;}
  .pcombo{font-size:11px;color:var(--muted);margin-top:2px;}
  .me-lbl{font-size:10px;color:var(--accent);letter-spacing:.1em;text-transform:uppercase;margin-left:6px;opacity:.8;}

  .pcards{display:flex;gap:6px;}
  .pcards .card{width:44px;height:62px;font-size:14px;}
  .pcards .cs{font-size:18px;}
  .pcards .cc{font-size:9px;}

  .chips{display:flex;gap:6px;flex-wrap:wrap;}
  .chip{width:42px;height:42px;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0;}
  .chip-s{font-size:10px;line-height:1;text-align:center;font-family:'Bebas Neue',sans-serif;}
  .chip.avail{border-color:rgba(255,255,255,.2);background:var(--s2);color:var(--text);}
  .chip.avail:hover{border-color:var(--accent);color:var(--accent);transform:scale(1.08);}
  .chip.sel{border-color:var(--accent);background:rgba(232,200,74,.15);color:var(--accent);transform:scale(1.05);box-shadow:0 0 12px rgba(232,200,74,.3);}
  .chip.taken{border-color:var(--s2);background:transparent;color:var(--muted);cursor:not-allowed;opacity:.3;}

  .chip-actions{display:flex;gap:8px;margin-top:4px;}
  .cbtn{padding:9px 16px;border:none;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:15px;cursor:pointer;transition:all .15s;white-space:nowrap;}
  .cbtn-ok{background:var(--accent);color:#0e0e12;}
  .cbtn-ok:hover{background:#f0d460;}
  .cbtn-ok:disabled{background:var(--s2);color:var(--muted);cursor:not-allowed;}
  .cbtn-cancel{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--muted);}
  .cbtn-cancel:hover{border-color:var(--red);color:var(--red);}

  .hist{display:flex;gap:5px;align-items:center;flex-wrap:wrap;padding-top:8px;border-top:1px solid rgba(255,255,255,.05);}
  .hlbl{font-size:10px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-right:2px;flex-shrink:0;}
  .hchip{display:flex;flex-direction:column;align-items:center;gap:1px;width:36px;height:40px;border-radius:8px;justify-content:center;flex-shrink:0;border:1px solid rgba(255,255,255,.1);background:var(--s2);}
  .hchip.cur{border:2px solid var(--accent);background:rgba(232,200,74,.12);}
  .hchip .hs{font-size:13px;color:var(--muted);}
  .hchip.cur .hs{color:var(--accent);}
  .hchip .hl{font-size:9px;color:var(--muted);}

  .bottom{padding:16px 0 8px;display:flex;justify-content:center;}

  /* RESULT OVERLAY */
  .overlay{position:fixed;inset:0;background:rgba(14,14,18,.93);display:flex;align-items:center;justify-content:center;z-index:100;padding:24px;animation:fi .4s ease;overflow-y:auto;}
  @keyframes fi{from{opacity:0}to{opacity:1}}
  .rcard{background:var(--surface);border-radius:20px;padding:32px 28px;max-width:460px;width:100%;text-align:center;border:1px solid rgba(255,255,255,.08);}
  .remoji{font-size:56px;margin-bottom:12px;}
  .rtitle{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:.1em;margin-bottom:6px;}
  .rtitle.win{color:var(--green);}
  .rtitle.lose{color:var(--red);}
  .rsub{color:var(--muted);font-size:13px;margin-bottom:20px;}
  .rplayers{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;text-align:left;}
  .rrow{display:flex;align-items:center;gap:10px;background:var(--s2);border-radius:10px;padding:11px 14px;}
  .rrank{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--muted);width:24px;}
  .rname{flex:1;font-weight:600;}
  .rcombo{font-size:11px;color:var(--muted);}
  .rounds{display:flex;gap:6px;justify-content:center;margin-bottom:18px;flex-wrap:wrap;}
  .rpill{padding:5px 10px;border-radius:20px;font-size:11px;}
  .rpill.ok{background:rgba(61,184,122,.15);color:var(--green);border:1px solid rgba(61,184,122,.3);}
  .rpill.fail{background:rgba(224,80,80,.15);color:var(--red);border:1px solid rgba(224,80,80,.3);}
  .rpill.key{border-width:2px;font-weight:600;}

  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--red2);color:#fff;padding:11px 22px;border-radius:10px;font-size:14px;z-index:200;animation:ti .3s ease;}
  @keyframes ti{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
</style>
</head>
<body>
<div id="app">

<!-- JOIN -->
<div id="join" class="screen active">
  <div class="logo"><h1>THE GANG</h1><p>–ü–æ–∫–µ—Ä–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ ¬∑ –ö–æ–º–∞–Ω–¥–Ω–∞—è –∏–≥—Ä–∞</p></div>
  <div class="box" style="margin-top:24px;">
    <h2>–í–∞—à–µ –∏–º—è</h2>
    <input id="iname" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" maxlength="20">
    <div class="divider">–î–ï–ô–°–¢–í–ò–ï</div>
    <button class="btn btn-gold" id="bcreate">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£</button>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <input id="icode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" maxlength="3" style="text-transform:uppercase;letter-spacing:.2em;font-size:18px;">
      <button class="btn btn-gold" id="bjoin" style="width:auto;padding:14px 20px;margin-top:0;">–í–û–ô–¢–ò</button>
    </div>
    <div id="reconnect-wrap" style="display:none;margin-top:10px;">
      <div class="divider">–ü–û–°–õ–ï–î–ù–Ø–Ø –°–ï–°–°–ò–Ø</div>
      <button class="btn btn-ghost" id="breconnect">üîÑ –ü–ï–†–ï–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
    </div>
  </div>
</div>

<!-- LOBBY -->
<div id="lobby" class="screen">
  <div class="logo"><h1>THE GANG</h1></div>
  <div class="code-box">
    <div class="code-lbl">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã ‚Äî –ø–æ–¥–µ–ª–∏—Å—å —Å –¥—Ä—É–∑—å—è–º–∏</div>
    <div class="code" id="lcode" onclick="copyCode()">‚Äî</div>
    <div class="code-hint">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
  </div>
  <div class="box">
    <h2>–ò–≥—Ä–æ–∫–∏</h2>
    <div id="lplayers"></div>
    <p id="lwait" style="font-size:13px;color:var(--muted);text-align:center;padding:8px 0;"></p>
  </div>
  <button class="btn btn-gold" id="bstart" style="max-width:420px;width:100%;display:none;">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
  <button class="btn btn-ghost" id="bleave" style="max-width:420px;width:100%;margin-top:8px;">–í–´–ô–¢–ò</button>
</div>

<!-- GAME -->
<div id="game" class="screen">
  <div class="game-header">
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="gtitle">THE GANG</span>
      <span id="game-room-code" style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--muted);background:var(--s2);border-radius:8px;padding:4px 10px;letter-spacing:.15em;cursor:pointer;" title="–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" onclick="copyCode()"></span>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="phase-dots" id="pdots"></div>
      <div class="my-badge">–Ø: <span id="myname"></span></div>
      <span id="spectator-badge" style="display:none;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:#e05050;background:rgba(224,80,80,.1);border-radius:4px;padding:2px 6px;">–ó—Ä–∏—Ç–µ–ª—å</span>
      <button onclick="document.getElementById('combo-modal').style.display='flex'" style="background:var(--s2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--muted);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:.08em;padding:5px 10px;cursor:pointer;" title="–¢–∞–±–ª–∏—Ü–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π">‚òÖ –ö–û–ú–ë–û</button>
    </div>
  </div>
  <div class="comm-section">
    <div class="slabel">–û–±—â–∏–µ –∫–∞—Ä—Ç—ã</div>
    <div class="comm-cards" id="ccards"></div>
  </div>
  <div class="instr" id="instr"></div>
  <div class="players" id="players"></div>
  <div class="bottom" id="bottom"></div>
</div>

<!-- COMBINATIONS MODAL -->
<div id="combo-modal" style="display:none;position:fixed;inset:0;background:rgba(14,14,18,.93);z-index:150;align-items:center;justify-content:center;padding:24px;animation:fi .3s ease;" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:var(--surface);border-radius:20px;padding:28px;max-width:420px;width:100%;border:1px solid rgba(255,255,255,.08);max-height:90vh;overflow-y:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);letter-spacing:.1em;">–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø–æ–∫–µ—Ä–∞</div>
      <button onclick="document.getElementById('combo-modal').style.display='none'" style="background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1;">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;font-size:14px;">
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à</span><span style="color:var(--muted);">5 –∫–∞—Ä—Ç –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–ö–∞—Ä–µ</span><span style="color:var(--muted);">–ß–µ—Ç—ã—Ä–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–§—É–ª–ª-—Ö–∞—É—Å</span><span style="color:var(--muted);">–¢—Ä–æ–π–∫–∞ + –ø–∞—Ä–∞</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–§–ª–µ—à</span><span style="color:var(--muted);">5 –∫–∞—Ä—Ç –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–°—Ç—Ä–∏—Ç</span><span style="color:var(--muted);">5 –∫–∞—Ä—Ç –ø–æ –ø–æ—Ä—è–¥–∫—É</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–¢—Ä–æ–π–∫–∞</span><span style="color:var(--muted);">–¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–î–≤–µ –ø–∞—Ä—ã</span><span style="color:var(--muted);">–î–≤–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä—ã</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–ü–∞—Ä–∞</span><span style="color:var(--muted);">–î–≤–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</span></div>
      <div style="background:var(--s2);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text);font-weight:600;">–°—Ç–∞—Ä—à–∞—è –∫–∞—Ä—Ç–∞</span><span style="color:var(--muted);">–ù–∏—á–µ–≥–æ –∏–∑ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ</span></div>
    </div>
    <p style="font-size:11px;color:var(--muted);margin-top:14px;text-align:center;">–°–∏–ª–∞ –∏–¥—ë—Ç –æ—Ç —Å–∏–ª—å–Ω–µ–π—à–µ–≥–æ –∫ —Å–ª–∞–±–µ–π—à–µ–º—É ‚Üë</p>
  </div>
</div>

</div>
<script>
// ===== CARD EVAL =====
const VO={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:11,Q:12,K:13,A:14};
const SS={spades:'‚ô†',hearts:'‚ô•',diamonds:'‚ô¶',clubs:'‚ô£'};
const CN=['–°—Ç–∞—Ä—à–∞—è –∫–∞—Ä—Ç–∞','–ü–∞—Ä–∞','–î–≤–µ –ø–∞—Ä—ã','–¢—Ä–æ–π–∫–∞','–°—Ç—Ä–∏—Ç','–§–ª–µ—à','–§—É–ª–ª-—Ö–∞—É—Å','–ö–∞—Ä–µ','–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à'];
const cv=v=>VO[v]||parseInt(v);

function eval7(hand,comm){
  const all=[...hand,...comm];
  if(all.length<5){const v=hand.map(c=>cv(c.value)).sort((a,b)=>b-a);return[0,...v];}
  let best=null;
  for(let i=0;i<all.length;i++)for(let j=i+1;j<all.length;j++){
    const f=all.filter((_,k)=>k!==i&&k!==j);
    if(f.length!==5)continue;
    const s=s5(f);if(!best||cmp(s,best)>0)best=s;
  }
  return best||[0];
}

function s5(c){
  const v=c.map(x=>cv(x.value)).sort((a,b)=>b-a);
  const su=c.map(x=>x.suit);
  const fl=su.every(s=>s===su[0]);
  const uv=[...new Set(v)].sort((a,b)=>b-a);
  const st=(uv.length===5&&uv[0]-uv[4]===4)||(JSON.stringify(uv)===JSON.stringify([14,5,4,3,2]));
  const cnt={};v.forEach(x=>cnt[x]=(cnt[x]||0)+1);
  const g=Object.entries(cnt).sort((a,b)=>b[1]-a[1]||b[0]-a[0]);
  const fr=g.map(x=>x[1]);
  const tb=g.flatMap(x=>Array(+x[1]).fill(+x[0])).sort((a,b)=>b-a);
  let r;
  if(fl&&st)r=8;else if(fr[0]===4)r=7;else if(fr[0]===3&&fr[1]===2)r=6;
  else if(fl)r=5;else if(st)r=4;else if(fr[0]===3)r=3;
  else if(fr[0]===2&&fr[1]===2)r=2;else if(fr[0]===2)r=1;else r=0;
  return[r,...tb];
}

function cmp(a,b){for(let i=0;i<Math.max(a.length,b.length);i++){const d=(a[i]??0)-(b[i]??0);if(d)return d;}return 0;}
const cname=s=>CN[s[0]]||'';

// ===== RENDER CARD =====
function mkCard(card,up,delay=0){
  const d=document.createElement('div');
  d.className='card '+(up?`up ${card.suit}`:'dn');
  if(up){const s=SS[card.suit];d.innerHTML=`<div class="cc">${card.value}<br>${s}</div><div class="cs">${s}</div><div class="cc br">${card.value}<br>${s}</div>`;}
  if(delay>0){d.classList.add('anim');d.style.animationDelay=delay+'s';}
  return d;
}

// ===== STATE =====
let ws=null,myName='',roomId='',G=null,lastPhase=-1;
const HOST='the-gang.youlostbg-creator.partykit.dev';

// ===== RECONNECT =====
function saveSession(){try{localStorage.setItem('tg_session',JSON.stringify({name:myName,room:roomId}));}catch(e){}}
function loadSession(){try{return JSON.parse(localStorage.getItem('tg_session'));}catch(e){return null;}}
(function initReconnect(){
  const s=loadSession();
  if(s&&s.name&&s.room){
    const btn=document.getElementById('breconnect');
    const wrap=document.getElementById('reconnect-wrap');
    btn.textContent=`üîÑ –í–ï–†–ù–£–¢–¨–°–Ø (${s.name} ¬∑ ${s.room.toUpperCase()})`;
    wrap.style.display='block';
    btn.onclick=()=>{myName=s.name;connect(s.room);show('lobby');};
  }
})();

// ===== CONNECT =====
function connect(room){
  roomId=room;
  if(ws)ws.close();
  ws=new WebSocket(`wss://${HOST}/party/${room}`);
  ws.onopen=()=>{send({type:'join',name:myName});saveSession();};
  ws.onmessage=e=>{const m=JSON.parse(e.data);if(m.type==='state')onState(m.state);if(m.type==='error')toast(m.message);};
  ws.onclose=()=>toast('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
}
function send(m){if(ws&&ws.readyState===1)ws.send(JSON.stringify(m));}

// ===== STATE HANDLER =====
function onState(state){
  G=state;
  const me=state.players.find(p=>p.name===myName);
  if(state.status==='lobby'){show('lobby');renderLobby(state,me);}
  else{show('game');renderGame(state,me);}
}

// ===== LOBBY =====
function renderLobby(S,me){
  document.getElementById('lcode').textContent=roomId.toUpperCase();
  const list=document.getElementById('lplayers');
  list.innerHTML='';
  S.players.forEach(p=>{
    const r=document.createElement('div');r.className='lobby-player';
    r.innerHTML=`<div class="dot ${p.connected!==false?'dot-on':'dot-off'}"></div>
      <span>${p.name}${p.id===S.hostId?'<span class="badge">–•–æ—Å—Ç</span>':''}</span>`;
    list.appendChild(r);
  });
  document.getElementById('lwait').textContent=S.players.length<2?'–ñ–¥—ë–º —Ö–æ—Ç—è –±—ã –µ—â—ë –æ–¥–Ω–æ–≥–æ...':''+S.players.length+' –∏–≥—Ä–æ–∫(–∞) –≥–æ—Ç–æ–≤—ã';
  const bs=document.getElementById('bstart');
  bs.style.display=(me&&me.id===S.hostId&&S.players.length>=2)?'block':'none';
}

// ===== GAME =====
function renderGame(S,me){
  document.getElementById('myname').textContent=myName;
  const rc=document.getElementById('game-room-code');
  if(rc)rc.textContent=roomId.toUpperCase();
  // Spectator badge - player not in game players list
  const specBadge=document.getElementById('spectator-badge');
  if(specBadge)specBadge.style.display=(!me)?'inline':'none';
  renderDots(S);
  renderComm(S);
  renderInstr(S,me);
  renderPlayers(S,me);
  renderBottom(S,me);
  if(S.allChipsDone)renderResult(S);
}

function renderDots(S){
  const c=document.getElementById('pdots');c.innerHTML='';
  for(let i=0;i<4;i++){const d=document.createElement('div');d.className='pdot';
    if(i<S.chipPhase||S.allChipsDone)d.classList.add('done');
    else if(i===S.chipPhase)d.classList.add('active');
    c.appendChild(d);}
}

function renderComm(S){
  const c=document.getElementById('ccards');
  const vis=S.phase===0?0:S.phase===1?3:S.phase===2?4:5;
  const newPhase=S.phase!==lastPhase;
  if(newPhase)lastPhase=S.phase;
  c.innerHTML='';
  for(let i=0;i<5;i++){
    const card=S.community[i];const v=i<vis;
    const isNew=newPhase&&v&&((S.phase===1&&i<3)||(S.phase===2&&i===3)||(S.phase===3&&i===4));
    c.appendChild(mkCard(card,v,isNew?(i-(S.phase===1?0:S.phase===2?3:4))*.1:0));
  }
}

function renderInstr(S,me){
  const el=document.getElementById('instr');
  const pn=['–¥–æ —Ñ–ª–æ–ø–∞','–Ω–∞ —Ñ–ª–æ–ø–µ','–Ω–∞ —Ç—ë—Ä–Ω–µ','–Ω–∞ —Ä–∏–≤–µ—Ä–µ'];
  if(S.allChipsDone){el.innerHTML='–í—Å–µ —Ñ–∏—à–∫–∏ –≤—ã–±—Ä–∞–Ω—ã!';return;}
  const waiting=S.players.filter(p=>!p.ready&&p.currentChip===null);
  const iPicked=me&&(me.ready||me.currentChip!==null);
  if(!iPicked)el.innerHTML=`–í—ã–±–µ—Ä–∏ —Ñ–∏—à–∫—É <strong>${pn[S.chipPhase]}</strong> ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–∞ —Ç–≤–æ—è —Ä—É–∫–∞?`;
  else if(S.players.some(p=>!p.ready))el.innerHTML=`–ñ–¥—ë–º: ${S.players.filter(p=>!p.ready).map(p=>`<strong>${p.name}</strong>`).join(', ')}`;
  else el.innerHTML='–í—Å–µ –≤—ã–±—Ä–∞–ª–∏!';
}

function renderPlayers(S,me){
  const c=document.getElementById('players');c.innerHTML='';
  const rn=['–î–û','–§–õ','–¢–†','–†–í'];
  S.players.forEach(player=>{
    const isMe=player.name===myName;
    const panel=document.createElement('div');
    panel.className='ppanel'+(isMe?' me':'')+(player.connected===false?' offline':'');

    // Top row
    const top=document.createElement('div');top.className='ptop';

    const info=document.createElement('div');info.className='pinfo';
    info.innerHTML=`<div class="pname">${player.name}${isMe?'<span class="me-lbl">–Ø</span>':''}</div>`;
    if(S.allChipsDone){const sc=eval7(player.hand,S.community);info.innerHTML+=`<div class="pcombo">${cname(sc)}</div>`;}
    top.appendChild(info);

    const cards=document.createElement('div');cards.className='pcards';
    player.hand.forEach(card=>cards.appendChild(mkCard(card,card.suit!=='hidden')));
    top.appendChild(cards);

    // Chip UI ‚Äî only for me and only if not done
    if(isMe&&!S.allChipsDone){
      const n=S.players.length;
      const sel=document.createElement('div');sel.className='chips';
      let picked=player.currentChip;

      for(let stars=1;stars<=n;stars++){
        const takenByOther=S.players.some(p=>p.name!==myName&&p.ready&&p.chipChoices[S.chipPhase]===stars);
        const isPending=S.players.some(p=>p.name!==myName&&!p.ready&&p.currentChip===stars);
        const chip=document.createElement('div');
        const isSel=player.currentChip===stars;
        const isTaken=takenByOther;
        chip.className='chip '+(isTaken?'taken':isSel?'sel':'avail');
        chip.innerHTML=`<div class="chip-s">${'‚òÖ'.repeat(Math.min(stars,5))}<br>${stars}‚òÖ</div>`;
        if(!isTaken){
          chip.onclick=()=>{if(!player.ready)send({type:'pick_chip',stars});};
        }
        sel.appendChild(chip);
      }
      top.appendChild(sel);

      // OK + Cancel buttons
      if(!player.ready){
        const acts=document.createElement('div');acts.className='chip-actions';
        const ok=document.createElement('button');ok.className='cbtn cbtn-ok';ok.textContent='–û–ö';
        ok.disabled=player.currentChip===null;
        ok.onclick=()=>send({type:'confirm_chip'});
        acts.appendChild(ok);
        top.appendChild(acts);
      } else {
        // After confirm ‚Äî show cancel button
        const acts=document.createElement('div');acts.className='chip-actions';
        const cancel=document.createElement('button');cancel.className='cbtn cbtn-cancel';cancel.textContent='–û—Ç–º–µ–Ω–∞';
        cancel.onclick=()=>send({type:'cancel_chip'});
        acts.appendChild(cancel);
        top.appendChild(acts);
      }
    } else if(!isMe&&!S.allChipsDone){
      // Show other player's pending chip (if any) as visual indicator
      if(player.currentChip!==null||player.ready){
        const ind=document.createElement('div');
        ind.style.cssText='font-size:13px;color:var(--muted);';
        ind.textContent=player.ready?'‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª':'ü§î –í—ã–±–∏—Ä–∞–µ—Ç...';
        top.appendChild(ind);
      }
    }

    panel.appendChild(top);

    // Chip history
    const allChips=[...player.chipChoices];
    if(player.currentChip!==null&&!player.ready)allChips.push(null); // pending slot
    if(player.chipChoices.length>0){
      const hist=document.createElement('div');hist.className='hist';
      const lbl=document.createElement('span');lbl.className='hlbl';lbl.textContent='–§–∏—à–∫–∏:';hist.appendChild(lbl);
      player.chipChoices.forEach((s,ri)=>{
        const cur=!S.allChipsDone&&ri===S.chipPhase;
        const hc=document.createElement('div');hc.className='hchip'+(cur?' cur':'');
        hc.innerHTML=`<div class="hs">${s}‚òÖ</div><div class="hl">${rn[ri]}</div>`;
        hist.appendChild(hc);
      });
      panel.appendChild(hist);
    }

    c.appendChild(panel);
  });
}

function renderBottom(S,me){
  document.getElementById('bottom').innerHTML='';
}

// ===== RESULT =====
let resultShown=false;
function renderResult(S){
  if(resultShown)return;
  resultShown=true;

  const scores=S.players.map(p=>({
    name:p.name,hand:p.hand,
    score:eval7(p.hand,S.community),
    chips:p.chipChoices,
  }));
  const sorted=[...scores].sort((a,b)=>cmp(b.score,a.score));
  const commR=[[],S.community.slice(0,3),S.community.slice(0,4),S.community.slice(0,5)];
  const rr=commR.map((comm,round)=>{
    const rs=scores.map((p,i)=>({i,score:eval7(p.hand,comm),stars:p.chips[round]}));
    const by=[...rs].sort((a,b)=>cmp(a.score,b.score));
    const exp={};by.forEach((p,r)=>exp[p.i]=r+1);
    return scores.every((_,i)=>rs[i].stars===exp[i]);
  });
  const win=rr[3];

  const ov=document.createElement('div');ov.className='overlay';
  ov.onclick=e=>{if(e.target===ov){ov.remove();resultShown=false;}};
  const rc=document.createElement('div');rc.className='rcard';
  rc.innerHTML=`<div class="remoji">${win?'üèÜ':'üí•'}</div>
    <div class="rtitle ${win?'win':'lose'}">${win?'–ü–û–ë–ï–î–ê!':'–ü–†–û–í–ê–õ'}</div>
    <div class="rsub">${win?'–ù–∞ —Ä–∏–≤–µ—Ä–µ –≤—Å–µ –≤–µ—Ä–Ω–æ –æ—Ü–µ–Ω–∏–ª–∏ —Å–∏–ª—É —Ä—É–∫!':'–ù–∞ —Ä–∏–≤–µ—Ä–µ –ø–æ—Ä—è–¥–æ–∫ —Ñ–∏—à–µ–∫ –Ω–µ —Å–æ–≤–ø–∞–ª...'}</div>`;

  const pl=document.createElement('div');pl.className='rplayers';
  sorted.forEach((p,rank)=>{
    const row=document.createElement('div');row.className='rrow';
    const chips=p.chips.map((c,ri)=>`<span style="color:${rr[ri]?'var(--green)':'var(--red)'}">${c}‚òÖ</span>`).join(' ');
    row.innerHTML=`<div class="rrank">#${rank+1}</div>
      <div style="flex:1"><div class="rname">${p.name}</div><div class="rcombo">${cname(p.score)}</div></div>
      <div style="font-size:12px">${chips}</div>`;
    pl.appendChild(row);
  });
  rc.appendChild(pl);

  const bd=document.createElement('div');bd.className='rounds';
  ['–î–æ —Ñ–ª–æ–ø–∞','–§–ª–æ–ø','–¢—ë—Ä–Ω','–†–∏–≤–µ—Ä ‚≠ê'].forEach((l,i)=>{
    const pill=document.createElement('div');
    pill.className=`rpill ${rr[i]?'ok':'fail'}${i===3?' key':''}`;
    pill.textContent=l+' '+(rr[i]?'‚úì':'‚úó');
    bd.appendChild(pill);
  });
  rc.appendChild(bd);

  const me=S.players.find(p=>p.name===myName);
  if(me&&me.id===S.hostId){
    const btn=document.createElement('button');btn.className='btn btn-gold';btn.style.marginTop='4px';
    btn.textContent='–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê';
    btn.onclick=()=>{ov.remove();resultShown=false;send({type:'restart'});};
    rc.appendChild(btn);
  } else {
    const btn=document.createElement('button');btn.className='btn btn-ghost';btn.style.marginTop='4px';
    btn.textContent='–í –õ–û–ë–ë–ò';
    btn.onclick=()=>{ov.remove();resultShown=false;send({type:'restart'});};
    rc.appendChild(btn);
  }
  ov.appendChild(rc);document.body.appendChild(ov);
}

// ===== HELPERS =====
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='game')document.getElementById('game').classList.add('active');
  resultShown=false;
}
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);}
function copyCode(){navigator.clipboard.writeText(roomId.toUpperCase()).then(()=>toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));}
function genRoom(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';return Array.from({length:3},()=>c[Math.floor(Math.random()*c.length)]).join('').toLowerCase();}

// ===== EVENTS =====
document.getElementById('bcreate').onclick=()=>{
  const n=document.getElementById('iname').value.trim();
  if(!n){toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return;}
  myName=n;connect(genRoom());show('lobby');
};
document.getElementById('bjoin').onclick=()=>{
  const n=document.getElementById('iname').value.trim();
  const c=document.getElementById('icode').value.trim().toLowerCase();
  if(!n){toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return;}
  if(!c){toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');return;}
  myName=n;connect(c);show('lobby');
};
document.getElementById('icode').onkeyup=e=>{if(e.key==='Enter')document.getElementById('bjoin').click();};
document.getElementById('bstart').onclick=()=>send({type:'start'});
document.getElementById('bleave').onclick=()=>{send({type:'leave'});if(ws)ws.close();show('join');};
</script>
</body>
</html>
